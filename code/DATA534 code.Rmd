---
title: "DATA534 CODE"
author: "Yuzhu Han"
date: "2025-03-11"
output: html_document
---

```{r}
library(httr)
library(jsonlite)
```

```{r}
weather_url <- "https://api.weatherbit.io/v2.0/alerts"
my_key <- Sys.getenv("WEATHERBIT_API_KEY")
```

### lat&lon

```{r}
weather_alert_lat <- function(lat, lon, api_key){
  if (missing(lat) || missing(lon) || missing(api_key)) {
    stop("All parameters (lat, lon, api_key) are required.")
  }
  
  base_url = "https://api.weatherbit.io/v2.0/alerts"
  
  # set parameters 
  params <- list(
    lat = lat,
    lon = lon,
    key = api_key
  )
  
  # request API
  response <- GET(base_url, query = params)
  
  # check response status
  if (response$status_code == 200) {
    print("Connected to WeatherBit API successfully!")
    response_data <- fromJSON(content(response, "text", encoding = "UTF-8"))
    
  } else {
    stop(paste("Error: API request failed! \nStatus code:", response$status_code))
  }

  # location data
  location <- data.frame(
    city_name = response_data$city_name,
    state_code = response_data$state_code,
    country_code = response_data$country_code,
    lat = response_data$lat,
    lon = response_data$lon,
    timezone = response_data$timezone
  )
  
  # ensure output is a dataframe even if no alerts exist
  if (!("alerts" %in% names(response_data)) || length(response_data$alerts) == 0) {
    message("No active weather alerts for the location.")
    
    # create an empty alerts dataframe with location
    empty_alerts_df <- data.frame(
      title = NA, severity = NA, effective_local = NA, expires_local = NA,
      regions = NA, uri = NA
    )

    # combine location with empty alerts dataframe
    return(cbind(location, empty_alerts_df))
  }

  # convert alerts to a data frame
  alerts_df <- as.data.frame(response_data$alerts)
  
  # flatten 'regions' if it's a list
  if ("regions" %in% colnames(alerts_df)) {
    alerts_df$regions <- sapply(alerts_df$regions, function(x) paste(x, collapse = "; "))
  }
  
  final_df <- cbind(location, alerts_df)

  return(alerts_df)
}
```

```{r}
test_df = weather_alert_lat(lat = "28.53834", lon = "-81.37924", api_key = my_key)
print(test_df)
```


### city name

```{r}
weather_alert_city <- function(city, state = NULL, country = NULL, api_key){
  if (missing(city) || missing(api_key)) {
    stop("All parameters (city, api_key) are required.")
  }
  
  # handle the optional parameter
  if (is.null(state) && is.null(country)) {
    stop("Error: The API requires either a state or a country along with the city name.")
  }
  
  base_url = "https://api.weatherbit.io/v2.0/alerts"
  
  # set parameters 
  params <- list(
    city = city,
    key = api_key
  )
  # add the optional parameters 
  if (!is.null(state)) {
    params$state <- state
  }
  if (!is.null(country)) {
    params$country <- country
  }
  
  # request API
  response <- GET(base_url, query = params)
  
  # check response status
  if (response$status_code == 200) {
    print("Connected to WeatherBit API successfully!")
    response_data <- fromJSON(content(response, "text", encoding = "UTF-8"))
    
  } else {
    stop(paste("Error: API request failed! \nStatus code:", response$status_code))
  }

  # location data
  location <- data.frame(
    city_name = response_data$city_name,
    state_code = response_data$state_code,
    country_code = response_data$country_code,
    lat = response_data$lat,
    lon = response_data$lon,
    timezone = response_data$timezone
  )
  
  # ensure output is a dataframe even if no alerts exist
  if (!("alerts" %in% names(response_data)) || length(response_data$alerts) == 0) {
    message("No active weather alerts for the location.")
    
    # create an empty alerts dataframe with location
    empty_alerts_df <- data.frame(
      title = NA, severity = NA, effective_local = NA, expires_local = NA,
      regions = NA, uri = NA
    )

    # combine location with empty alerts dataframe
    return(cbind(location, empty_alerts_df))
  }

  # convert alerts to a data frame
  alerts_df <- as.data.frame(response_data$alerts)
  
  # flatten 'regions' if it's a list
  if ("regions" %in% colnames(alerts_df)) {
    alerts_df$regions <- sapply(alerts_df$regions, function(x) paste(x, collapse = "; "))
  }
  
  final_df <- cbind(location, alerts_df)

  return(alerts_df)
}
```

```{r}
test_df = weather_alert_city("Orlando", country = "US", api_key = my_key)
print(test_df)
```











